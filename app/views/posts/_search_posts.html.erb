<%# ============================================================
    PARTIAL: _search_posts.html.erb
    Î§ÏÎ®ÏƒÎ·: Î²Î¬Î»Ï„Î¿ Î‘ÎœÎ•Î£Î©Î£ Î¼ÎµÏ„Î¬ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ "ÎÎ­Î± Î‘Î½Î¬ÏÏ„Î·ÏƒÎ·" ÏƒÏ„Î¿ view ÏƒÎ±Ï‚
    
    Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Ï‡ÏÎ®ÏƒÎ·Ï‚:
      <%= render 'search_posts' %>
    
    Î‘Ï€Î±Î¹Ï„ÎµÎ¯ route:  GET /posts/search  (Î´ÎµÎ¯Ï„Îµ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰)
    ============================================================ %>

<style>
  /* â”€â”€ Search Bar Row â”€â”€ */
  .search-bar-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* ÎšÎ¿Ï…Î¼Ï€Î¯ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚ â€“ Î¯Î´Î¹Î¿ ÏÏˆÎ¿Ï‚ Î¼Îµ "ÎÎ­Î± Î‘Î½Î¬ÏÏ„Î·ÏƒÎ·" */
  #search-toggle-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #fff;
    color: #0084ff;
    border: 1.5px solid #0084ff;
    font-size: 14px;
    font-weight: 700;
    padding: 7px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.18s ease;
    white-space: nowrap;
    font-family: -apple-system, sans-serif;
  }
  #search-toggle-btn:hover {
    background: #0084ff;
    color: #fff;
  }
  #search-toggle-btn svg {
    transition: transform 0.2s;
  }
  #search-toggle-btn.active svg {
    transform: rotate(45deg);
  }

  /* â”€â”€ Expandable Panel â”€â”€ */
  #search-panel {
    display: none;
    background: #fff;
    border-radius: 12px;<%# ============================================================
    PARTIAL: _search_posts.html.erb
    Î§ÏÎ®ÏƒÎ·: Î²Î¬Î»Ï„Î¿ Î‘ÎœÎ•Î£Î©Î£ Î¼ÎµÏ„Î¬ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ "ÎÎ­Î± Î‘Î½Î¬ÏÏ„Î·ÏƒÎ·" ÏƒÏ„Î¿ view ÏƒÎ±Ï‚
    
    Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Ï‡ÏÎ®ÏƒÎ·Ï‚:
      <%= render 'search_posts' %>
    
    Î‘Ï€Î±Î¹Ï„ÎµÎ¯ route:  GET /posts/search  (Î´ÎµÎ¯Ï„Îµ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰)
    ============================================================ %>

<style>
  /* â”€â”€ Search Bar Row â”€â”€ */
  .search-bar-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* ÎšÎ¿Ï…Î¼Ï€Î¯ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚ â€“ Î¯Î´Î¹Î¿ ÏÏˆÎ¿Ï‚ Î¼Îµ "ÎÎ­Î± Î‘Î½Î¬ÏÏ„Î·ÏƒÎ·" */
  #search-toggle-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #fff;
    color: #0084ff;
    border: 1.5px solid #0084ff;
    font-size: 14px;
    font-weight: 700;
    padding: 7px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.18s ease;
    white-space: nowrap;
    font-family: -apple-system, sans-serif;
  }
  #search-toggle-btn:hover {
    background: #0084ff;
    color: #fff;
  }
  #search-toggle-btn svg {
    transition: transform 0.2s;
  }
  #search-toggle-btn.active svg {
    transform: rotate(45deg);
  }

  /* â”€â”€ Expandable Panel â”€â”€ */
  #search-panel {
    display: none;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.10);
    padding: 18px 20px 14px;
    margin-top: 10px;
    animation: slideDown 0.22s ease;
  }
  #search-panel.open { display: block; }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* â”€â”€ Search Input Row â”€â”€ */
  .sp-input-row {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }
  #sp-keyword {
    flex: 1;
    border: 1.5px solid #e4e6eb;
    border-radius: 20px;
    padding: 9px 16px;
    font-size: 14px;
    outline: none;
    font-family: -apple-system, sans-serif;
    transition: border-color 0.15s;
  }
  #sp-keyword:focus { border-color: #0084ff; }

  #sp-search-btn {
    background: #0084ff;
    color: #fff;
    border: none;
    border-radius: 20px;
    padding: 9px 20px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.15s;
    font-family: -apple-system, sans-serif;
  }
  #sp-search-btn:hover { background: #0073e6; }

  /* â”€â”€ Filters Row â”€â”€ */
  .sp-filters {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
    align-items: center;
  }
  .sp-filters label {
    font-size: 12px;
    color: #65676b;
    font-weight: 600;
    margin-right: 2px;
  }
  .sp-select {
    border: 1.5px solid #e4e6eb;
    border-radius: 20px;
    padding: 6px 12px;
    font-size: 13px;
    outline: none;
    background: #f0f2f5;
    cursor: pointer;
    font-family: -apple-system, sans-serif;
    transition: border-color 0.15s;
  }
  .sp-select:focus { border-color: #0084ff; }

  /* â”€â”€ User Chips (Ï€Î¿Î»Î»Î±Ï€Î»Î¿Î¯ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚) â”€â”€ */
  .sp-users-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 10px;
  }
  .sp-users-row label {
    font-size: 12px;
    color: #65676b;
    font-weight: 600;
  }
  .user-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: #e7f3ff;
    color: #0084ff;
    border: 1px solid #cce4ff;
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    user-select: none;
  }
  .user-chip:hover { background: #d0e8ff; }
  .user-chip.selected {
    background: #0084ff;
    color: #fff;
    border-color: #0084ff;
  }
  .user-chip .chip-avatar {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
  }

  /* â”€â”€ Results Area â”€â”€ */
  #sp-results-area {
    display: none;
    margin-top: 14px;
    border-top: 1px solid #f0f2f5;
    padding-top: 12px;
  }
  #sp-results-area.visible { display: block; }

  .sp-category-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 800;
    color: #65676b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 12px 0 6px;
  }
  .sp-category-header span {
    background: #e4e6eb;
    border-radius: 10px;
    padding: 1px 7px;
    font-size: 11px;
    color: #444;
  }

  .sp-post-card {
    display: flex;
    gap: 10px;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.12s;
    text-decoration: none;
    color: inherit;
  }
  .sp-post-card:hover { background: #f0f2f5; }

  .sp-post-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #e7f3ff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .sp-post-body { flex: 1; min-width: 0; }
  .sp-post-author {
    font-size: 13px;
    font-weight: 700;
    color: #050505;
  }
  .sp-post-snippet {
    font-size: 12px;
    color: #65676b;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 1px;
  }
  .sp-post-meta {
    font-size: 11px;
    color: #aaa;
    margin-top: 2px;
  }
  .sp-badge {
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 10px;
    font-weight: 700;
    flex-shrink: 0;
    align-self: flex-start;
    margin-top: 4px;
  }
  .sp-badge.photo { background:#fff3cd; color:#856404; }
  .sp-badge.video { background:#d4edda; color:#155724; }
  .sp-badge.text  { background:#e7f3ff; color:#004085; }
  .sp-badge.link  { background:#f8d7da; color:#721c24; }

  #sp-empty {
    text-align: center;
    padding: 20px;
    color: #65676b;
    font-size: 14px;
    display: none;
  }
  #sp-loading {
    text-align: center;
    padding: 16px;
    color: #0084ff;
    font-size: 13px;
    display: none;
  }
  .sp-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #cce4ff;
    border-top-color: #0084ff;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<%# â”€â”€ ÎšÎ¿Ï…Î¼Ï€Î¯ Toggle â”€â”€ %>
<button id="search-toggle-btn" onclick="toggleSearchPanel()" type="button">
  <svg width="15" height="15" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
    <circle cx="9" cy="9" r="7"/><line x1="14.5" y1="14.5" x2="19" y2="19"/>
  </svg>
  Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Posts
</button>

<%# â”€â”€ Expandable Panel â”€â”€ %>
<div id="search-panel">

  <%# Input row %>
  <div class="sp-input-row">
    <input type="text" id="sp-keyword"
           placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î»Î­Î¾Î·Ï‚-ÎºÎ»ÎµÎ¹Î´Î¯..."
           onkeydown="if(event.key==='Enter') runSearch()">
    <button id="sp-search-btn" onclick="runSearch()" type="button">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</button>
  </div>

  <%# Î¦Î¯Î»Ï„ÏÎ± %>
  <div class="sp-filters">
    <label>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±:</label>
    <select id="sp-category" class="sp-select">
      <option value="">ÎŒÎ»ÎµÏ‚</option>
      <option value="text">ğŸ“ ÎšÎµÎ¯Î¼ÎµÎ½Î¿</option>
      <option value="photo">ğŸ“· Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</option>
      <option value="video">ğŸ¬ Î’Î¯Î½Ï„ÎµÎ¿</option>
      <option value="link">ğŸ”— Î£ÏÎ½Î´ÎµÏƒÎ¼Î¿Ï‚</option>
    </select>

    <label style="margin-left:8px;">Î¤Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ·:</label>
    <select id="sp-sort" class="sp-select">
      <option value="newest">ÎÎµÏŒÏ„ÎµÏÎ± Ï€ÏÏÏ„Î±</option>
      <option value="oldest">Î Î±Î»Î±Î¹ÏŒÏ„ÎµÏÎ± Ï€ÏÏÏ„Î±</option>
      <option value="popular">Î Î¹Î¿ Î´Î·Î¼Î¿Ï†Î¹Î»Î®</option>
    </select>
  </div>

  <%# Î Î¿Î»Î»Î±Ï€Î»Î¿Î¯ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ %>
  <div class="sp-users-row" id="sp-users-row">
    <label>ğŸ‘¤ Î§ÏÎ®ÏƒÏ„Î·Ï‚:</label>
    <%# Chip "ÎŒÎ»Î¿Î¹" %>
    <div class="user-chip selected" data-uid="all" onclick="toggleUserChip(this)">
      <div class="chip-avatar">ğŸŒ</div>
      ÎŒÎ»Î¿Î¹
    </div>
    <%# ÎˆÎ½Î± chip Î±Î½Î¬ Ï†Î¯Î»Î¿ %>
    <% current_user.friend_users.each do |u| %>
      <div class="user-chip" data-uid="<%= u.id %>" onclick="toggleUserChip(this)">
        <div class="chip-avatar">ğŸ‘¤</div>
        <%= u.username || u.email.split('@').first %>
      </div>
    <% end %>
    <%# Chip Î³Î¹Î± Ï„Î¿Î½ Î¯Î´Î¹Î¿ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· %>
    <div class="user-chip" data-uid="<%= current_user.id %>" onclick="toggleUserChip(this)">
      <div class="chip-avatar">â­</div>
      Î•Î³Ï
    </div>
  </div>

  <%# Loading & Empty states %>
  <div id="sp-loading"><span class="sp-spinner"></span>Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·...</div>
  <div id="sp-empty">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±.</div>

  <%# Results %>
  <div id="sp-results-area"></div>
</div>

<script>
// â”€â”€ Toggle panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSearchPanel() {
  const panel = document.getElementById('search-panel');
  const btn   = document.getElementById('search-toggle-btn');
  const isOpen = panel.classList.contains('open');
  panel.classList.toggle('open', !isOpen);
  btn.classList.toggle('active', !isOpen);
}

// â”€â”€ User chip multi-select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleUserChip(chip) {
  const uid = chip.dataset.uid;
  if (uid === 'all') {
    // Î‘Î½ Ï€Î±Ï„Î®ÏƒÎ¿Ï…Î¼Îµ "ÎŒÎ»Î¿Î¹", Î±Ï€Î¿ÎµÏ€Î¹Î»Î­Î³Î¿Ï…Î¼Îµ Ï„Î¿Ï…Ï‚ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Ï…Ï‚
    document.querySelectorAll('.user-chip').forEach(c => c.classList.remove('selected'));
    chip.classList.add('selected');
  } else {
    // Î‘Ï€Î¿ÎµÏ€Î¹Î»Î­Î³Î¿Ï…Î¼Îµ Ï„Î¿ "ÎŒÎ»Î¿Î¹"
    const allChip = document.querySelector('.user-chip[data-uid="all"]');
    if (allChip) allChip.classList.remove('selected');
    chip.classList.toggle('selected');
    // Î‘Î½ ÎºÎ±Î½ÎµÎ¯Ï‚ Î´ÎµÎ½ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯, Î¾Î±Î½Î±Î²Î¬Î¶Î¿Ï…Î¼Îµ Ï„Î¿ "ÎŒÎ»Î¿Î¹"
    const anySelected = document.querySelectorAll('.user-chip:not([data-uid="all"]).selected').length > 0;
    if (!anySelected && allChip) allChip.classList.add('selected');
  }
}

// â”€â”€ Î£Ï…Î»Î»Î¿Î³Î® ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Ï‰Î½ UIDs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSelectedUids() {
  const allChip = document.querySelector('.user-chip[data-uid="all"]');
  if (allChip && allChip.classList.contains('selected')) return [];
  return Array.from(document.querySelectorAll('.user-chip:not([data-uid="all"]).selected'))
              .map(c => c.dataset.uid);
}

// â”€â”€ Î•Î¹ÎºÎ¿Î½Î¯Î´Î¹Î¿ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function categoryIcon(type) {
  return { photo:'ğŸ“·', video:'ğŸ¬', text:'ğŸ“', link:'ğŸ”—' }[type] || 'ğŸ“„';
}

// â”€â”€ ÎšÏÏÎ¹Î± Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runSearch() {
  const keyword  = document.getElementById('sp-keyword').value.trim();
  const category = document.getElementById('sp-category').value;
  const sort     = document.getElementById('sp-sort').value;
  const uids     = getSelectedUids();

  const loading  = document.getElementById('sp-loading');
  const empty    = document.getElementById('sp-empty');
  const results  = document.getElementById('sp-results-area');

  loading.style.display = 'block';
  empty.style.display   = 'none';
  results.classList.remove('visible');
  results.innerHTML = '';

  // Î§Ï„Î¯Î¶Î¿Ï…Î¼Îµ query params
  const params = new URLSearchParams();
  if (keyword)  params.set('q',        keyword);
  if (category) params.set('category', category);
  if (sort)     params.set('sort',     sort);
  uids.forEach(id => params.append('user_ids[]', id));

  fetch('/posts/search?' + params.toString(), {
    headers: {
      'Accept': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
    }
  })
  .then(r => r.json())
  .then(data => {
    loading.style.display = 'none';

    if (!data || data.length === 0) {
      empty.style.display = 'block';
      return;
    }

    // â”€â”€ ÎŸÎ¼Î±Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± â”€â”€
    const groups = {};
    data.forEach(post => {
      const cat = post.post_type || 'text';
      if (!groups[cat]) groups[cat] = [];
      groups[cat].push(post);
    });

    // â”€â”€ Rendering â”€â”€
    const categoryLabels = {
      text:  'ğŸ“ ÎšÎµÎ¯Î¼ÎµÎ½Î¿',
      photo: 'ğŸ“· Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±',
      video: 'ğŸ¬ Î’Î¯Î½Ï„ÎµÎ¿',
      link:  'ğŸ”— Î£ÏÎ½Î´ÎµÏƒÎ¼Î¿Ï‚'
    };

    Object.entries(groups).forEach(([cat, posts]) => {
      const header = document.createElement('div');
      header.className = 'sp-category-header';
      header.innerHTML = `${categoryLabels[cat] || cat} <span>${posts.length}</span>`;
      results.appendChild(header);

      posts.forEach(post => {
        const card = document.createElement('a');
        card.className  = 'sp-post-card';
        card.href       = `/posts/${post.id}`;
        card.innerHTML  = `
          <div class="sp-post-avatar">${categoryIcon(cat)}</div>
          <div class="sp-post-body">
            <div class="sp-post-author">${escHtml(post.author_name || 'Î§ÏÎ®ÏƒÏ„Î·Ï‚')}</div>
            <div class="sp-post-snippet">${escHtml(post.body || post.title || '')}</div>
            <div class="sp-post-meta">${post.created_at || ''}</div>
          </div>
          <div class="sp-badge ${cat}">${categoryLabels[cat] || cat}</div>
        `;
        results.appendChild(card);
      });
    });

    results.classList.add('visible');
  })
  .catch(() => {
    loading.style.display = 'none';
    empty.style.display   = 'block';
    empty.textContent     = 'Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.';
  });
}

function escHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>

    box-shadow: 0 4px 20px rgba(0,0,0,0.10);
    padding: 18px 20px 14px;
    margin-top: 10px;
    animation: slideDown 0.22s ease;
  }
  #search-panel.open { display: block; }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* â”€â”€ Search Input Row â”€â”€ */
  .sp-input-row {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }
  #sp-keyword {
    flex: 1;
    border: 1.5px solid #e4e6eb;
    border-radius: 20px;
    padding: 9px 16px;
    font-size: 14px;
    outline: none;
    font-family: -apple-system, sans-serif;
    transition: border-color 0.15s;
  }
  #sp-keyword:focus { border-color: #0084ff; }

  #sp-search-btn {
    background: #0084ff;
    color: #fff;
    border: none;
    border-radius: 20px;
    padding: 9px 20px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.15s;
    font-family: -apple-system, sans-serif;
  }
  #sp-search-btn:hover { background: #0073e6; }

  /* â”€â”€ Filters Row â”€â”€ */
  .sp-filters {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
    align-items: center;
  }
  .sp-filters label {
    font-size: 12px;
    color: #65676b;
    font-weight: 600;
    margin-right: 2px;
  }
  .sp-select {
    border: 1.5px solid #e4e6eb;
    border-radius: 20px;
    padding: 6px 12px;
    font-size: 13px;
    outline: none;
    background: #f0f2f5;
    cursor: pointer;
    font-family: -apple-system, sans-serif;
    transition: border-color 0.15s;
  }
  .sp-select:focus { border-color: #0084ff; }

  /* â”€â”€ User Chips (Ï€Î¿Î»Î»Î±Ï€Î»Î¿Î¯ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚) â”€â”€ */
  .sp-users-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 10px;
  }
  .sp-users-row label {
    font-size: 12px;
    color: #65676b;
    font-weight: 600;
  }
  .user-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: #e7f3ff;
    color: #0084ff;
    border: 1px solid #cce4ff;
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    user-select: none;
  }
  .user-chip:hover { background: #d0e8ff; }
  .user-chip.selected {
    background: #0084ff;
    color: #fff;
    border-color: #0084ff;
  }
  .user-chip .chip-avatar {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
  }

  /* â”€â”€ Results Area â”€â”€ */
  #sp-results-area {
    display: none;
    margin-top: 14px;
    border-top: 1px solid #f0f2f5;
    padding-top: 12px;
  }
  #sp-results-area.visible { display: block; }

  .sp-category-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 800;
    color: #65676b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 12px 0 6px;
  }
  .sp-category-header span {
    background: #e4e6eb;
    border-radius: 10px;
    padding: 1px 7px;
    font-size: 11px;
    color: #444;
  }

  .sp-post-card {
    display: flex;
    gap: 10px;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.12s;
    text-decoration: none;
    color: inherit;
  }
  .sp-post-card:hover { background: #f0f2f5; }

  .sp-post-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #e7f3ff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .sp-post-body { flex: 1; min-width: 0; }
  .sp-post-author {
    font-size: 13px;
    font-weight: 700;
    color: #050505;
  }
  .sp-post-snippet {
    font-size: 12px;
    color: #65676b;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 1px;
  }
  .sp-post-meta {
    font-size: 11px;
    color: #aaa;
    margin-top: 2px;
  }
  .sp-badge {
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 10px;
    font-weight: 700;
    flex-shrink: 0;
    align-self: flex-start;
    margin-top: 4px;
  }
  .sp-badge.photo { background:#fff3cd; color:#856404; }
  .sp-badge.video { background:#d4edda; color:#155724; }
  .sp-badge.text  { background:#e7f3ff; color:#004085; }
  .sp-badge.link  { background:#f8d7da; color:#721c24; }

  #sp-empty {
    text-align: center;
    padding: 20px;
    color: #65676b;
    font-size: 14px;
    display: none;
  }
  #sp-loading {
    text-align: center;
    padding: 16px;
    color: #0084ff;
    font-size: 13px;
    display: none;
  }
  .sp-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #cce4ff;
    border-top-color: #0084ff;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<%# â”€â”€ ÎšÎ¿Ï…Î¼Ï€Î¯ Toggle â”€â”€ %>
<button id="search-toggle-btn" onclick="toggleSearchPanel()" type="button">
  <svg width="15" height="15" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
    <circle cx="9" cy="9" r="7"/><line x1="14.5" y1="14.5" x2="19" y2="19"/>
  </svg>
  Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Posts
</button>

<%# â”€â”€ Expandable Panel â”€â”€ %>
<div id="search-panel">

  <%# Input row %>
  <div class="sp-input-row">
    <input type="text" id="sp-keyword"
           placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î»Î­Î¾Î·Ï‚-ÎºÎ»ÎµÎ¹Î´Î¯..."
           onkeydown="if(event.key==='Enter') runSearch()">
    <button id="sp-search-btn" onclick="runSearch()" type="button">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</button>
  </div>

  <%# Î¦Î¯Î»Ï„ÏÎ± %>
  <div class="sp-filters">
    <label>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±:</label>
    <select id="sp-category" class="sp-select">
      <option value="">ÎŒÎ»ÎµÏ‚</option>
      <option value="text">ğŸ“ ÎšÎµÎ¯Î¼ÎµÎ½Î¿</option>
      <option value="photo">ğŸ“· Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</option>
      <option value="video">ğŸ¬ Î’Î¯Î½Ï„ÎµÎ¿</option>
      <option value="link">ğŸ”— Î£ÏÎ½Î´ÎµÏƒÎ¼Î¿Ï‚</option>
    </select>

    <label style="margin-left:8px;">Î¤Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ·:</label>
    <select id="sp-sort" class="sp-select">
      <option value="newest">ÎÎµÏŒÏ„ÎµÏÎ± Ï€ÏÏÏ„Î±</option>
      <option value="oldest">Î Î±Î»Î±Î¹ÏŒÏ„ÎµÏÎ± Ï€ÏÏÏ„Î±</option>
      <option value="popular">Î Î¹Î¿ Î´Î·Î¼Î¿Ï†Î¹Î»Î®</option>
    </select>
  </div>

  <%# Î Î¿Î»Î»Î±Ï€Î»Î¿Î¯ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ %>
  <div class="sp-users-row" id="sp-users-row">
    <label>ğŸ‘¤ Î§ÏÎ®ÏƒÏ„Î·Ï‚:</label>
    <%# Chip "ÎŒÎ»Î¿Î¹" %>
    <div class="user-chip selected" data-uid="all" onclick="toggleUserChip(this)">
      <div class="chip-avatar">ğŸŒ</div>
      ÎŒÎ»Î¿Î¹
    </div>
    <%# ÎˆÎ½Î± chip Î±Î½Î¬ Ï†Î¯Î»Î¿ %>
    <% current_user.friend_users.each do |u| %>
      <div class="user-chip" data-uid="<%= u.id %>" onclick="toggleUserChip(this)">
        <div class="chip-avatar">ğŸ‘¤</div>
        <%= u.username || u.email.split('@').first %>
      </div>
    <% end %>
    <%# Chip Î³Î¹Î± Ï„Î¿Î½ Î¯Î´Î¹Î¿ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· %>
    <div class="user-chip" data-uid="<%= current_user.id %>" onclick="toggleUserChip(this)">
      <div class="chip-avatar">â­</div>
      Î•Î³Ï
    </div>
  </div>

  <%# Loading & Empty states %>
  <div id="sp-loading"><span class="sp-spinner"></span>Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·...</div>
  <div id="sp-empty">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±.</div>

  <%# Results %>
  <div id="sp-results-area"></div>
</div>

<script>
// â”€â”€ Toggle panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSearchPanel() {
  const panel = document.getElementById('search-panel');
  const btn   = document.getElementById('search-toggle-btn');
  const isOpen = panel.classList.contains('open');
  panel.classList.toggle('open', !isOpen);
  btn.classList.toggle('active', !isOpen);
}

// â”€â”€ User chip multi-select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleUserChip(chip) {
  const uid = chip.dataset.uid;
  if (uid === 'all') {
    // Î‘Î½ Ï€Î±Ï„Î®ÏƒÎ¿Ï…Î¼Îµ "ÎŒÎ»Î¿Î¹", Î±Ï€Î¿ÎµÏ€Î¹Î»Î­Î³Î¿Ï…Î¼Îµ Ï„Î¿Ï…Ï‚ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Ï…Ï‚
    document.querySelectorAll('.user-chip').forEach(c => c.classList.remove('selected'));
    chip.classList.add('selected');
  } else {
    // Î‘Ï€Î¿ÎµÏ€Î¹Î»Î­Î³Î¿Ï…Î¼Îµ Ï„Î¿ "ÎŒÎ»Î¿Î¹"
    const allChip = document.querySelector('.user-chip[data-uid="all"]');
    if (allChip) allChip.classList.remove('selected');
    chip.classList.toggle('selected');
    // Î‘Î½ ÎºÎ±Î½ÎµÎ¯Ï‚ Î´ÎµÎ½ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯, Î¾Î±Î½Î±Î²Î¬Î¶Î¿Ï…Î¼Îµ Ï„Î¿ "ÎŒÎ»Î¿Î¹"
    const anySelected = document.querySelectorAll('.user-chip:not([data-uid="all"]).selected').length > 0;
    if (!anySelected && allChip) allChip.classList.add('selected');
  }
}

// â”€â”€ Î£Ï…Î»Î»Î¿Î³Î® ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Ï‰Î½ UIDs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSelectedUids() {
  const allChip = document.querySelector('.user-chip[data-uid="all"]');
  if (allChip && allChip.classList.contains('selected')) return [];
  return Array.from(document.querySelectorAll('.user-chip:not([data-uid="all"]).selected'))
              .map(c => c.dataset.uid);
}

// â”€â”€ Î•Î¹ÎºÎ¿Î½Î¯Î´Î¹Î¿ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function categoryIcon(type) {
  return { photo:'ğŸ“·', video:'ğŸ¬', text:'ğŸ“', link:'ğŸ”—' }[type] || 'ğŸ“„';
}

// â”€â”€ ÎšÏÏÎ¹Î± Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runSearch() {
  const keyword  = document.getElementById('sp-keyword').value.trim();
  const category = document.getElementById('sp-category').value;
  const sort     = document.getElementById('sp-sort').value;
  const uids     = getSelectedUids();

  const loading  = document.getElementById('sp-loading');
  const empty    = document.getElementById('sp-empty');
  const results  = document.getElementById('sp-results-area');

  loading.style.display = 'block';
  empty.style.display   = 'none';
  results.classList.remove('visible');
  results.innerHTML = '';

  // Î§Ï„Î¯Î¶Î¿Ï…Î¼Îµ query params
  const params = new URLSearchParams();
  if (keyword)  params.set('q',        keyword);
  if (category) params.set('category', category);
  if (sort)     params.set('sort',     sort);
  uids.forEach(id => params.append('user_ids[]', id));

  fetch('/posts/search?' + params.toString(), {
    headers: {
      'Accept': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
    }
  })
  .then(r => r.json())
  .then(data => {
    loading.style.display = 'none';

    if (!data || data.length === 0) {
      empty.style.display = 'block';
      return;
    }

    // â”€â”€ ÎŸÎ¼Î±Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± â”€â”€
    const groups = {};
    data.forEach(post => {
      const cat = post.post_type || 'text';
      if (!groups[cat]) groups[cat] = [];
      groups[cat].push(post);
    });

    // â”€â”€ Rendering â”€â”€
    const categoryLabels = {
      text:  'ğŸ“ ÎšÎµÎ¯Î¼ÎµÎ½Î¿',
      photo: 'ğŸ“· Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±',
      video: 'ğŸ¬ Î’Î¯Î½Ï„ÎµÎ¿',
      link:  'ğŸ”— Î£ÏÎ½Î´ÎµÏƒÎ¼Î¿Ï‚'
    };

    Object.entries(groups).forEach(([cat, posts]) => {
      const header = document.createElement('div');
      header.className = 'sp-category-header';
      header.innerHTML = `${categoryLabels[cat] || cat} <span>${posts.length}</span>`;
      results.appendChild(header);

      posts.forEach(post => {
        const card = document.createElement('a');
        card.className  = 'sp-post-card';
        card.href       = `/posts/${post.id}`;
        card.innerHTML  = `
          <div class="sp-post-avatar">${categoryIcon(cat)}</div>
          <div class="sp-post-body">
            <div class="sp-post-author">${escHtml(post.author_name || 'Î§ÏÎ®ÏƒÏ„Î·Ï‚')}</div>
            <div class="sp-post-snippet">${escHtml(post.body || post.title || '')}</div>
            <div class="sp-post-meta">${post.created_at || ''}</div>
          </div>
          <div class="sp-badge ${cat}">${categoryLabels[cat] || cat}</div>
        `;
        results.appendChild(card);
      });
    });

    results.classList.add('visible');
  })
  .catch(() => {
    loading.style.display = 'none';
    empty.style.display   = 'block';
    empty.textContent     = 'Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.';
  });
}

function escHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
